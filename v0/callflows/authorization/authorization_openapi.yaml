openapi: 3.0.3
info: 
  title: OIDC Authorization
  description: Check the [Authorization guide](/docs/authorization)
  contact:
    name: Telef√≥nica Open Gateway DevRel
    url: https://opengateway.telefonica.com/en/developer-hub
    email: devrel@telefonica.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

  version: "1"

servers:
  - url: "{host}"
    variables:
      host:
        default: sandbox.opengateway.telefonica.com/apigateway
        description: API gateway URL
paths:
  /authorize:
    get:
      summary: Auth Code Flow
      tags:
        - Authorize an application
      security:
        - {}
      description: |
        Authorizes an application to access a resource from the user device

        Check the [Frontend authorization flow guide](/docs/frontend) for more information.

        Create an app on our [Sandbox](/docs/sandbox) to get credentials so you can perform API calls to our operators' production environments, or use the following convenience client ID to test it in mock mode:
        
        `mock_sandbox_app_id`
      operationId: authorize
      parameters: 
        - name: response_type
          in: query
          description: The response type
          required: true
          schema:
            type: string
            enum:
              - code
        - name: client_id
          in: query
          description: Your application client ID
          required: true
          schema:
            type: string
        - name: scope
          in: query
          description: The purpose and scope of the authorization. Check every API reference description for the proper scope.
          required: true
          schema:
            type: string
        - name: redirect_uri
          in: query
          description: The redirect URI
          required: true
          schema:
            type: string
        - name: login_hint
          in: query
          description: The login hint
          required: false
          schema:
            type: string
        - name: state
          in: query
          description: The state
          required: false
          schema:
            type: string
        - name: nonce
          in: query
          description: The nonce
          required: false
          schema:
            type: string
      responses:
        "302":
          description: Redirects to the `redirect_uri` with the authorization code in the query string
        "400":
          $ref: "#/components/responses/Generic400"
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
  /bc-authorize:
    post:
      summary: CIBA
      tags:
        - Authorize an application
      security:
        - basicAuth: []
      description: |
        Authorizes an application to access a resource from the backend

        Check the [Backend authorization flow guide](/docs/backend) for more information.
        
        Create an app on our [Sandbox](/docs/sandbox) to get credentials so you can perform API calls to our operators' production environments, or use the following convenience client credentials to test it in mock mode:
        
        `mock_sandbox_app_id` / `mock_sandbox_app_secret`

        ## Available API Scopes

        Use the following scopes for different APIs:

        ### Age Verification
        - `dpv:FraudPreventionAndDetection kyc-age-verification:verify`

        ### Device Location
        - `dpv:FraudPreventionAndDetection#device-location-read`

        ### Device Status
        - `dpv:FraudPreventionAndDetection#device-status-roaming-read`

        ### Device Swap Detection
        - `dpv:FraudPreventionAndDetection#device-swap`

        ### Know Your Customer
        - `dpv:FraudPreventionAndDetection#kyc-match:match`

        ### Number Verification
        - `dpv:FraudPreventionAndDetection#number-verification-verify-read`

        ### Quality on Demand
        - `dpv:RequestedServiceProvision#qod`

        ### SIM Swap
        - `dpv:FraudPreventionAndDetection#sim-swap`

        ### Tenure
        - `dpv:FraudPreventionAndDetection#kyc-tenure`
      operationId: bcAuthorize
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: "#/components/schemas/AuthorizeRequest"
        required: true
      responses:
        "200":
          description: Returns an authorization code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthorizationRequestId"
        "400":
          $ref: "#/components/responses/Generic400"
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
  /token:
    post:
      summary: /token
      tags:
        - Retrieve an access token
      security: 
        - basicAuth: []
      description: |
        Retrieves an access token from the authorization code (frontend) or auth_req_id (backend)

        Check the [Authorization guide](/docs/authorization) for more information.
        
        Create an app on our [Sandbox](/docs/sandbox) to get credentials so you can perform API calls to our operators' production environments, or use the following convenience token to test our APIs in mock mode:
        
        `mock_sandbox_access_token`
      operationId: token
      requestBody: 
        content:
          application/x-www-form-urlencoded:
            schema:
              oneOf: 
                - $ref: "#/components/schemas/AccessTokenAuthCodeRequest"
                - $ref: "#/components/schemas/AccessTokenCIBARequest"
        required: true
      responses:
        "200":
          description: Returns an access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessToken"
        "400":
          $ref: "#/components/responses/Generic400"
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: Basic authentication
    none:
      type: http
      scheme: none
  schemas:
    AuthorizeRequest:
      type: object
      properties:
        login_hint:
          type: string
          description: |
            The login hint to be used by the operator to identify the end-user, in the following format `<identifier_type>:<identifier>`, those being:
            - `tel` for phone numbers. The `login_hint` must be a tel URI as defined in [RFC 3966](https://www.rfc-editor.org/info/rfc3966) for global phone numbers without visual separators in [E.164](https://www.itu.int/rec/T-REC-E.164-201011-I/en) format, including "+". For example, `tel:+34666666666`.
            - `ipport` for IPv4 and IPv6 addresses, that can optionally include a port. For example, `ipport:80.90.34.2:16790`, `ipport:80.90.34.2`, `ipport:[2001:db8::1]:8080` or `ipport:[2001:db8::1]`
            
            Check the [Backend authorization flow guide](/docs/backend) for more information.
        scope:
          type: string
          description: dpv:<w3c_purpose>#<scope>
      required:
        - login_hint
        - scope
    AuthorizationRequestId:
      type: object
      properties:
        auth_req_id:
          type: string
          description: Authorization request ID
        expires_in:
          type: integer
          format: int32
          description: Expiration time in seconds
        interval:
          type: integer
          format: int32
          description: Polling interval in seconds
      required:
        - request_id
    AccessTokenAuthCodeRequest:
      type: object
      properties:
        grant_type:
          type: string
          description: The grant type
          enum:
            - authorization_code
        code:
          type: string
          description: The authorization code
        redirect_uri:
          type: string
          description: The redirect URI
    AccessTokenCIBARequest:
      type: object
      properties:
        grant_type:
          type: string
          description: The grant type
          enum:
            - urn:openid:params:grant-type:ciba
        auth_req_id:
          type: string
          description: The authorization request ID
    AccessToken:
      type: object
      properties:
        access_token:
          type: string
          description: Access token
        token_type:
          type: string
          description: Token type
        expires_in:
          type: integer
          format: int32
          description: Expiration time in seconds
        refresh_token:
          type: string
          description: Refresh token
        id_token:
          type: string
          description: ID token
        scope:
          type: string
          description: Access token scope
        purpose:
          type: string
          description: Purpose of the access token
      required:
        - access_token
        - token_type
        - expires_in
    Error:
      type: object
      properties:
        code:
          type: integer
          format: int32
          description: Error code
        message:
          type: string
          description: Error message
      required:
        - code
        - message
  responses:
    Generic400:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Generic401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Generic403:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"